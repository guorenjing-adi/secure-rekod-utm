<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rekod IT UTM | MOE Edition</title>
    
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://fonts.googleapis.com https://fonts.gstatic.com https://*.supabase.co https://cdn.sheetjs.com; 
    style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com; 
    script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://cdn.sheetjs.com;
    connect-src 'self' https://*.supabase.co https://api.emailjs.com https://cdn.jsdelivr.net https://unpkg.com;
">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --base-font-size: 16px; 
            --primary: #1e293b;
            --accent: #4f46e5;
        }
        html { font-size: var(--base-font-size); scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b;
            overflow-x: hidden; 
            width: 100vw;
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .hidden-section { display: none !important; }
        
        .table-container { 
            width: 100%; 
            overflow-x: auto; 
            border: 1px solid #f1f5f9; 
            background: white; 
            border-radius: 0.75rem;
            -webkit-overflow-scrolling: touch;
        }
        
        table { border-collapse: separate; border-spacing: 0; width: 100%; min-width: 900px; }
        th, td { padding: 0.75rem 1rem; }
        th { background: #f8fafc; font-weight: 600; border-bottom: 2px solid #f1f5f9; color: #475569; position: sticky; top: 0; z-index: 10; }

        .wrap-mode table { min-width: 100% !important; table-layout: auto !important; }
        .wrap-mode th, .wrap-mode td { 
            white-space: normal !important; 
            word-break: break-word; 
            font-size: 14px !important; 
            padding: 0.75rem !important;
            vertical-align: top;
        }

        .compact-mode .table-container { overflow-x: hidden !important; }
        .compact-mode table { 
            min-width: 100% !important; 
            table-layout: fixed !important; 
            width: 100% !important;
        }
        .compact-mode th, .compact-mode td { 
            white-space: nowrap !important; 
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            font-size: clamp(6px, 0.7vw, 10px) !important; 
            padding: 0.3rem 0.4rem !important;
            letter-spacing: -0.02em;
        }

        .loader {
            border: 3px solid #e2e8f0; border-top: 3px solid var(--accent); border-radius: 50%;
            width: 48px; height: 48px; animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .login-btn-anim.loading { background-color: #0f172a !important; color: transparent !important; pointer-events: none; }
        .login-btn-anim.loading::after {
            content: "UTM"; position: absolute; color: #f8fafc; font-weight: 800; font-size: 1.25rem;
            animation: pulse-zoom 1.5s ease-in-out infinite;
        }

        .tab-active-main { 
            background-color: white !important; 
            color: var(--accent) !important; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .tab-active-sub { 
            color: var(--accent) !important; 
            border-bottom: 3px solid var(--accent) !important; 
            background-color: transparent !important;
        }
        
        .glass-header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
        }
        .card-modern {
            background: white;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 20px -2px rgba(0,0,0,0.05);
            border-radius: 1rem;
        }
        .input-modern {
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
        }
        
        .row-late { background-color: #fef2f2 !important; } 
        .text-late { color: #dc2626 !important; font-weight: 700; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="index-page" class="flex-grow flex flex-col items-center justify-center bg-white">
        <div class="loader mb-6"></div>
        <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight">Rekod IT UTM</h1>
        <p class="text-slate-400 text-sm mt-2 font-medium">Initializing secure connection...</p>
    </div>

    <div id="login-page" class="hidden-section flex-grow flex flex-col items-center justify-center p-6 bg-slate-50">
        <div class="card-modern p-10 w-full max-w-md form-enter">
            <div class="text-center mb-10">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl mb-4 shadow-sm">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900">Sistem Rekod IT</h1>
                <p class="text-slate-500 text-sm mt-1">Akses Pangkalan Data & Inventori</p>
            </div>
            <form id="login-form" class="space-y-5">
                <input type="email" id="email" class="input-modern w-full px-4 py-3 rounded-xl" placeholder="nama@utm.my" required>
                <input type="password" id="password" class="input-modern w-full px-4 py-3 rounded-xl" placeholder="••••••••" required>
                <div id="login-error" class="text-red-500 text-sm hidden"></div>
                <button type="submit" id="login-btn" class="login-btn-anim btn-hover w-full bg-indigo-600 text-white font-bold py-4 rounded-xl">Akses Sistem</button>
            </form>
        </div>
    </div>

    <div id="main-page" class="hidden-section min-h-screen flex flex-col">
        <nav class="glass-header text-white shadow-xl sticky top-0 z-50 border-b border-slate-800">
            <div class="w-full px-4 md:px-6 py-3 flex flex-col lg:flex-row justify-between items-center gap-4">
                <div class="flex items-center w-full lg:w-auto justify-between lg:justify-start">
                    <div class="flex items-center gap-3 mr-6 md:mr-10">
                        <div class="p-2 bg-indigo-500 rounded-lg"><i data-lucide="database" class="w-5 h-5"></i></div>
                        <span class="font-extrabold text-lg md:text-xl tracking-tight">UTM <span class="text-indigo-400">IT</span></span>
                    </div>
                    <div class="flex gap-1 bg-slate-800/50 p-1 rounded-xl border border-slate-700 overflow-x-auto">
                        <button onclick="Navigation.switchModule('call-log')" id="nav-call-log" class="whitespace-nowrap px-4 py-2 rounded-lg text-xs font-bold transition-all tab-active-main">Call Log</button>
                        <button onclick="Navigation.switchModule('loan')" id="nav-loan" class="whitespace-nowrap px-4 py-2 rounded-lg text-xs font-bold transition-all">Pinjaman ICT</button>
                        <button onclick="Navigation.switchModule('assets')" id="nav-assets" class="whitespace-nowrap px-4 py-2 rounded-lg text-xs font-bold transition-all">Aset ICT</button>
                        <button onclick="Navigation.switchModule('summary')" id="nav-summary" class="whitespace-nowrap px-4 py-2 rounded-lg text-xs font-bold transition-all">Ringkasan</button>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span id="user-display" class="text-slate-300 text-xs font-semibold px-3 py-1.5 bg-slate-800 rounded-full"></span>
                    <button onclick="Auth.logout()" class="bg-rose-500 hover:bg-rose-600 px-4 py-2 rounded-lg text-xs font-bold">Keluar</button>
                </div>
            </div>
        </nav>

        <main class="flex-grow p-4 md:p-6 lg:p-10 max-w-[1920px] mx-auto w-full" id="app-main-content">
            <div id="summary-module" class="hidden-section w-full space-y-8 md:space-y-12">
                <div class="card-modern p-6 md:p-10 flex flex-col items-center">
                    <div class="text-center mb-8">
                        <h2 class="text-xl md:text-3xl font-black text-slate-800 tracking-tighter uppercase">Statistik Bulanan <span id="summary-year-display"></span></h2>
                        <p class="text-slate-400 font-bold text-xs md:text-sm mt-1 uppercase tracking-widest">Analisis Prestasi Perkhidmatan & Aset</p>
                    </div>

                    <div class="w-full max-w-4xl mx-auto mb-12 bg-slate-50 p-6 rounded-3xl border border-slate-100">
                        <canvas id="summaryChart" class="max-h-[400px]"></canvas>
                    </div>

                    <div class="w-full space-y-4 mb-10">
                        <div class="flex items-center justify-between px-2">
                            <h3 class="font-extrabold text-slate-800 text-sm md:text-base flex items-center gap-2">
                                <i data-lucide="table-2" class="w-5 h-5 text-indigo-500"></i> Jadual Statistik Tahunan
                            </h3>
                            <button onclick="Summary.init()" class="bg-slate-100 p-2 rounded-lg hover:bg-indigo-100 text-indigo-600 transition-all"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                        </div>
                        <div class="table-container shadow-2xl shadow-slate-200/50 border border-slate-100">
                            <table id="summary-table" class="data-table">
                                <thead class="bg-slate-50 border-b border-slate-100 text-[10px] md:text-[11px] font-black uppercase tracking-wider text-slate-500">
                                    <tr>
                                        <th class="p-4 text-center">BIL</th>
                                        <th class="p-4 text-left">Perkara</th>
                                        <th class="p-4 text-center">JAN</th><th class="p-4 text-center">FEB</th><th class="p-4 text-center">MAR</th>
                                        <th class="p-4 text-center">APR</th><th class="p-4 text-center">MEI</th><th class="p-4 text-center">JUN</th>
                                        <th class="p-4 text-center">JUL</th><th class="p-4 text-center">OGO</th><th class="p-4 text-center">SEP</th>
                                        <th class="p-4 text-center">OKT</th><th class="p-4 text-center">NOV</th><th class="p-4 text-center">DIS</th>
                                        <th class="p-4 text-center bg-indigo-50 text-indigo-700">Jumlah</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body" class="text-[10px] md:text-xs font-bold text-slate-600"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="w-full space-y-4">
                        <div class="flex items-center justify-between px-2">
                            <h3 class="font-extrabold text-slate-800 text-sm md:text-base flex items-center gap-2">
                                <i data-lucide="monitor" class="w-5 h-5 text-emerald-500"></i> Statistik Pinjaman Peralatan (TAG ASET)
                            </h3>
                        </div>
                        <div class="table-container shadow-2xl shadow-slate-200/50 border border-slate-100">
                            <table id="device-summary-table" class="data-table">
                                <thead class="bg-slate-50 border-b border-slate-100 text-[10px] md:text-[11px] font-black uppercase tracking-wider text-slate-500">
                                    <tr>
                                        <th class="p-4 text-center">BIL</th>
                                        <th class="p-4 text-left">Tag Aset</th>
                                        <th class="p-4 text-center">JAN</th><th class="p-4 text-center">FEB</th><th class="p-4 text-center">MAR</th>
                                        <th class="p-4 text-center">APR</th><th class="p-4 text-center">MEI</th><th class="p-4 text-center">JUN</th>
                                        <th class="p-4 text-center">JUL</th><th class="p-4 text-center">OGO</th><th class="p-4 text-center">SEP</th>
                                        <th class="p-4 text-center">OKT</th><th class="p-4 text-center">NOV</th><th class="p-4 text-center">DIS</th>
                                        <th class="p-4 text-center bg-emerald-50 text-emerald-700">Jumlah</th>
                                    </tr>
                                </thead>
                                <tbody id="device-summary-body" class="text-[10px] md:text-xs font-bold text-slate-600"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    // ... (Previous modules like CallLog, Records, Assets remain the same)

        const Summary = {
            chart: null,
            init: async () => {
                const year = new Date().getFullYear();
                document.getElementById('summary-year-display').innerText = year;
                
                // Clear and show loaders for both tables
                const tb = document.getElementById('summary-table-body');
                const devTb = document.getElementById('device-summary-body');
                const loaderHtml = '<tr><td colspan="15" class="p-10 text-center"><div class="loader mx-auto"></div></td></tr>';
                tb.innerHTML = loaderHtml;
                devTb.innerHTML = loaderHtml;

                try {
                    // 1. FETCH DATA
                    const { data: calls } = await sbClient.from('rekod')
                        .select('created_at, sistem, komunikasi') 
                        .gte('created_at', `${year}-01-01`)
                        .lte('created_at', `${year}-12-31`);
                        
                    const { data: loans } = await sbClient.from('rekod_pinjaman')
                        .select('created_at, device_tag')
                        .gte('created_at', `${year}-01-01`)
                        .lte('created_at', `${year}-12-31`);

                    const { data: inventory } = await sbClient.from('device_inventory')
                        .select('tag')
                        .order('tag', { ascending: true });

                    const processMonths = (items) => {
                        const counts = new Array(12).fill(0);
                        items?.forEach(item => {
                            const month = new Date(item.created_at).getMonth();
                            counts[month]++;
                        });
                        return counts;
                    };

                    // 2. PROCESS MAIN SUMMARY TABLE
                    const callCounts = processMonths(calls);
                    const loanCounts = processMonths(loans);
                    const solmanCounts = processMonths(calls?.filter(r => 
                        (r.sistem && r.sistem.toUpperCase() === 'SOLMAN') || 
                        (r.komunikasi && r.komunikasi.toUpperCase() === 'SOLMAN')
                    ));
                    const spmpCounts = processMonths(calls?.filter(r => r.sistem && r.sistem.includes('SPMP (MYGOVUC3.0\\GMAIL)')));
                    const adCounts = processMonths(calls?.filter(r => r.sistem && r.sistem.includes('AD (DOMAIN)')));
                    
                    tb.innerHTML = '';
                    const renderRow = (bil, title, counts, color) => {
                        const total = counts.reduce((a, b) => a + b, 0);
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-slate-50 hover:bg-slate-50 transition-all cursor-pointer";
                        tr.innerHTML = `
                            <td class="p-4 text-center text-slate-400 font-bold">${bil}</td>
                            <td class="p-4 font-black uppercase text-slate-800">${title}</td>
                            ${counts.map(c => `<td class="p-4 text-center font-bold text-slate-600">${c}</td>`).join('')}
                            <td class="p-4 text-center bg-indigo-50 text-indigo-700 font-black">${total}</td>
                        `;
                        tr.onclick = () => Summary.renderChart(counts, title, color);
                        tb.appendChild(tr);
                    };

                    renderRow(1, "Log Panggilan (Call Log)", callCounts, '#6366f1');
                    renderRow(2, "Rekod Pinjaman Peralatan", loanCounts, '#10b981');
                    renderRow(3, "SOLMAN (Sistem & Komunikasi)", solmanCounts, '#f59e0b');
                    renderRow(4, "SPMP (MYGOVUC3.0\\GMAIL)", spmpCounts, '#06b6d4');
                    renderRow(5, "AD (DOMAIN)", adCounts, '#f43f5e');

                    // 3. PROCESS DEVICE USAGE TABLE (TAG ASET)
                    devTb.innerHTML = '';
                    if (inventory) {
                        inventory.forEach((device, index) => {
                            const deviceUsage = loans?.filter(l => l.device_tag === device.tag) || [];
                            const monthlyCounts = processMonths(deviceUsage);
                            const totalUsage = monthlyCounts.reduce((a, b) => a + b, 0);
                            
                            const tr = document.createElement('tr');
                            tr.className = "border-b border-slate-50 hover:bg-emerald-50/30 transition-all";
                            tr.innerHTML = `
                                <td class="p-4 text-center text-slate-400 font-bold">${index + 1}</td>
                                <td class="p-4 font-black uppercase text-slate-700">${device.tag}</td>
                                ${monthlyCounts.map(c => `<td class="p-4 text-center font-medium ${c > 0 ? 'text-emerald-600' : 'text-slate-300'}">${c}</td>`).join('')}
                                <td class="p-4 text-center bg-emerald-50 text-emerald-700 font-black">${totalUsage}</td>
                            `;
                            devTb.appendChild(tr);
                        });
                    }

                    // Default chart
                    Summary.renderChart(callCounts, "Log Panggilan (Call Log)", '#6366f1');

                } catch (e) {
                    console.error("Summary Error:", e);
                }
            },
            renderChart: (dataArray, label, barColor) => {
                const ctx = document.getElementById('summaryChart').getContext('2d');
                if (Summary.chart) Summary.chart.destroy();
                Summary.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['JAN', 'FEB', 'MAR', 'APR', 'MEI', 'JUN', 'JUL', 'OGO', 'SEP', 'OKT', 'NOV', 'DIS'],
                        datasets: [{
                            label: label,
                            data: dataArray,
                            backgroundColor: barColor,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }
        };

        // ... (Remaining initialization code for DOMContentLoaded)

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            Auth.init();
            document.getElementById('login-form').addEventListener('submit', Auth.login);
            // Ensure global search is active
            const gSearch = document.getElementById('global-search');
            if(gSearch) gSearch.addEventListener('input', (e) => CallLog.handleSearch(e.target.value));
            
            const dForm = document.getElementById('data-form');
            if(dForm) dForm.addEventListener('submit', CallLog.submit);
        });
    </script>
</body>
</html>
